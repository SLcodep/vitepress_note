---
title: Promise
date: 2025-11-27 17:24:35
permalink: /qian/promise
# titleTag: 
categories:
  - å‰ç«¯
tags:
  - å‰ç«¯
---

<CollapsibleToc 
  title="å¿«é€Ÿå¯¼èˆª" 
  :defaultOpen="true" 
  :minLevel="2" 
  :maxLevel="3" 
/>

::: details èƒŒæ™¯
ES6 ä¹‹å‰ï¼Œå¼‚æ­¥ç¼–ç¨‹é å›è°ƒå‡½æ•°ï¼Œå¤šå±‚åµŒå¥—ä¼šå½¢æˆ â€œå›è°ƒåœ°ç‹±â€ã€‚å›è°ƒåœ°ç‹±çš„é—®é¢˜æ˜¯ä»£ç å¯è¯»æ€§å·®å’Œé”™è¯¯å¤„ç†å›°éš¾ï¼Œæ¯”å¦‚ä¸‹é¢é¢å¯¹æ¯ä¸€ä¸ªç¯èŠ‚å¦‚æœå‡ºç°é—®é¢˜ï¼Œè¦ç»™å‡ºå¯¹åº”çš„"ç™»å½•å¤±è´¥""è·å¾—ç”¨æˆ·IDå¤±è´¥"ç­‰ç­‰
**åœºæ™¯**: ä¸€ä¸ªçœŸå®çš„ä¸šåŠ¡åœºæ™¯ - ç”¨æˆ·ç™»å½•åè·å–ä¸ªäººä¿¡æ¯
å‡è®¾æˆ‘ä»¬è¦å®Œæˆä»¥ä¸‹æ­¥éª¤ï¼š
1. ç”¨æˆ·ç™»å½•ï¼Œè·å– token
2. ç”¨token è·å–ç”¨æˆ· ID
3. ç”¨ç”¨æˆ· ID è·å–ç”¨æˆ·è¯¦ç»†ä¿¡æ¯
4. ç”¨ç”¨æˆ·ä¿¡æ¯è·å–ç”¨æˆ·çš„è®¢å•åˆ—è¡¨
5. ç”¨è®¢å• ID è·å–è®¢å•è¯¦æƒ…
```js
// å›è°ƒåœ°ç‹±ï¼šåµŒå¥—è¶Šæ·±ï¼Œå¯è¯»æ€§è¶Šå·®
login('zhangsan', '123456', (loginResult) => {
  getUserId(loginResult.token, (userIdResult) => {
    getUserInfo(userIdResult.userId, (userInfo) => {
      console.log('ç”¨æˆ·ä¿¡æ¯:', userInfo);
      getOrders(userIdResult.userId, (orders) => {
        console.log('è®¢å•åˆ—è¡¨:', orders);
        getOrderDetail(orders[0].orderId, (orderDetail) => {
          console.log('è®¢å•è¯¦æƒ…:', orderDetail);
          // ğŸ˜± å¦‚æœè¿˜æœ‰æ›´å¤šæ­¥éª¤ï¼ŒåµŒå¥—ä¼šæ›´æ·±...
        });
      });
    });
  });
});
```
:::

## åŸç†éƒ¨åˆ†
ä¸ºäº†è§£å†³å›è°ƒåœ°ç‹±çš„é—®é¢˜ï¼Œå°±å…ˆåå‡ºç°äº†promiseã€Generatorå’Œasync/awaitã€‚
### 1.Promiseçš„è§£å†³æ€è·¯
Promise æ˜¯ä¸€ä¸ªä»£è¡¨å¼‚æ­¥æ“ä½œæœ€ç»ˆå®Œæˆæˆ–å¤±è´¥çš„å¯¹è±¡ã€‚
- å°†å¼‚æ­¥æ“ä½œçš„ç»“æœå°è£…ä¸ºä¸€ä¸ªã€ŒçŠ¶æ€æœºã€ï¼ˆpending/fulfilled/rejectedï¼‰ï¼ŒçŠ¶æ€ä¸€æ—¦æ”¹å˜ä¸å¯é€†è½¬ï¼›
- ç”¨`.then()`é“¾å¼è°ƒç”¨æ›¿ä»£åµŒå¥—å›è°ƒï¼Œå¼‚æ­¥æµç¨‹çº¿æ€§åŒ–ï¼›
- ç”¨`.catch()`ç»Ÿä¸€æ•è·é”™è¯¯ï¼Œæ›¿ä»£æ¯å±‚å›è°ƒçš„ err åˆ¤æ–­ã€‚

```js
//1.å°†å¼‚æ­¥æ“ä½œå°è£…ä¸ºä¸€ä¸ªå¯¹è±¡
function login(username, password) {
  return new Promise((resolve, reject) => {
    setTimeout(() => {
      console.log('1. ç™»å½•æˆåŠŸ');
      resolve({ token: 'abc123' });
    }, 1000);
  });
}


//2.ä½¿ç”¨é“¾å¼è°ƒç”¨ - æ‰å¹³åŒ–
login('zhangsan', '123456')
  .then(loginResult => {
    return getUserId(loginResult.token);
  })
  .then(userIdResult => {
    return getUserInfo(userIdResult.userId);
  })
  .then(userInfo => {
    console.log('ç”¨æˆ·ä¿¡æ¯:', userInfo);
    return getOrders(userInfo.userId || '001');
  })
  .then(orders => {
    console.log('è®¢å•åˆ—è¡¨:', orders);
    return getOrderDetail(orders[0].orderId);
  })
  .then(orderDetail => {
    console.log('è®¢å•è¯¦æƒ…:', orderDetail);
  })
  .catch(error => {
    // ç»Ÿä¸€çš„é”™è¯¯å¤„ç†ï¼
    console.error('å‘ç”Ÿé”™è¯¯:', error);
  });
```
promiseåœ¨é€šè¿‡é“¾å¼è°ƒç”¨ï¼Œå¤„ç†å›è°ƒå‡½æ•°ä½¿å¾—ä»£ç çš„å¯é˜…è¯»æ€§æ›´å¥½ï¼Œç»Ÿä¸€çš„é”™è¯¯å¤„ç†ä¹Ÿèƒ½å‡å°‘ä»£ç é‡ç­‰ã€‚ä½†æ˜¯Promiseä¹Ÿå­˜åœ¨ä¸€å®šçš„ç¼ºé™·ï¼š
1.ä»»ç„¶å­˜åœ¨ä¸€å®šçš„åµŒå¥—;
2.å› ä¸ºpromiseçš„ç‰¹æ€§å¯¼è‡´æ— æ³•ä¸­æ–­promiseé“¾
3.é”™è¯¯å¤„ç†ä¸å¤Ÿç›´è§‚ï¼Œæ’æŸ¥é”™è¯¯å›°éš¾

### 2.Generator çš„è¿‡æ¸¡
Generatoræ˜¯ES6å¼•å…¥çš„ä¸€ç§ç‰¹æ®Šå‡½æ•°ï¼Œå¯ä»¥æš‚åœæ‰§è¡Œå’Œæ¢å¤æ‰§è¡Œã€‚
**æ ¸å¿ƒæ€æƒ³**:
- å‡½æ•°å¯ä»¥"æš‚åœ"å’Œ"ç»§ç»­"
- ç”¨åŒæ­¥çš„æ–¹å¼å†™å¼‚æ­¥ä»£ç 
- éœ€è¦æ‰‹åŠ¨æ§åˆ¶æ‰§è¡Œæµç¨‹


::: code-group

```javascript [æ‰‹åŠ¨æ‰§è¡Œ]

function* fetchUserData() {
  console.log('å¼€å§‹è·å–æ•°æ®');
  
  // çœ‹èµ·æ¥åƒåŒæ­¥ä»£ç ï¼
  const loginResult = yield login('zhangsan', '123456');
  console.log('1. ç™»å½•æˆåŠŸ:', loginResult);
  
  const userIdResult = yield getUserId(loginResult.token);
  console.log('2. è·å–ç”¨æˆ·ID:', userIdResult);
  
  const userInfo = yield getUserInfo(userIdResult.userId);
  console.log('3. ç”¨æˆ·ä¿¡æ¯:', userInfo);
  
  const orders = yield getOrders(userIdResult.userId);
  console.log('4. è®¢å•åˆ—è¡¨:', orders);
  
  const orderDetail = yield getOrderDetail(orders[0].orderId);
  console.log('5. è®¢å•è¯¦æƒ…:', orderDetail);
  
  return orderDetail;
}

// æ‰‹åŠ¨æ‰§è¡Œ Generatorï¼ˆéœ€è¦ä¸€ä¸ªæ‰§è¡Œå™¨ï¼‰
function runGenerator(generatorFunc) {
  const gen = generatorFunc();
  
  function step(value) {
    const result = gen.next(value);
    
    if (result.done) {
      return result.value;
    }
    
    // å¦‚æœ yield çš„æ˜¯ Promiseï¼Œç­‰å¾…å®ƒå®Œæˆ
    if (result.value && typeof result.value.then === 'function') {
      result.value
        .then(val => step(val))
        .catch(err => gen.throw(err));
    } else {
      step(result.value);
    }
  }
  step();
}
// æ‰§è¡Œ
runGenerator(fetchUserData);
```

```javascript [coåº“å¯ä»¥è‡ªåŠ¨æ‰§è¡Œ]
// coåº“å¯ä»¥è‡ªåŠ¨æ‰§è¡Œ Generator
const co = require('co');

co(function* () {
  const loginResult = yield login('zhangsan', '123456');
  const userIdResult = yield getUserId(loginResult.token);
  const userInfo = yield getUserInfo(userIdResult.userId);
  const orders = yield getOrders(userIdResult.userId);
  const orderDetail = yield getOrderDetail(orders[0].orderId);
  
  console.log('æœ€ç»ˆç»“æœ:', orderDetail);
  return orderDetail;
})
  .then(result => {
    console.log('æˆåŠŸ:', result);
  })
  .catch(error => {
    console.error('å¤±è´¥:', error);
  });
```
:::

::: warning
Generatorçš„ç¼ºé™·
ç¼ºé™·1: éœ€è¦æ‰§è¡Œå™¨
ç¼ºé™·2: è¯­ä¹‰ä¸æ¸…æ™°
ç¼ºé™·3: å¼‚æ­¥æ‰§è¡Œéº»çƒ¦
:::

### 3.async/await
async/await åšçš„äº‹æƒ…å°±æ˜¯å°† Generator å‡½æ•°è½¬æ¢æˆ Promiseï¼Œè¯´ç™½äº†ï¼Œasync å‡½æ•°å°±æ˜¯ Generator å‡½æ•°çš„è¯­æ³•ç³–ï¼Œawait å‘½ä»¤å°±æ˜¯å†…éƒ¨ then å‘½ä»¤çš„è¯­æ³•ç³–ã€‚async å‡½æ•°å°±æ˜¯å°† Generator å‡½æ•°çš„æ˜Ÿå·ï¼ˆ*ï¼‰æ›¿æ¢æˆ asyncï¼Œå°† yield æ›¿æ¢æˆ awaitï¼Œä»…æ­¤è€Œå·²ã€‚å…¶å® async å‡½æ•°çš„å®ç°åŸç†ï¼Œå°±æ˜¯å°† Generator å‡½æ•°å’Œè‡ªåŠ¨æ‰§è¡Œå™¨(æ¯”å¦‚ co)ï¼ŒåŒ…è£…åœ¨ä¸€ä¸ªå‡½æ•°é‡Œã€‚

**æ ¸å¿ƒæ€æƒ³**:
- ç”¨åŒæ­¥çš„æ–¹å¼å†™å¼‚æ­¥ä»£ç 
- åŸºäº Promiseï¼Œä½†æ›´ç®€æ´
- åŸç”Ÿæ”¯æŒï¼Œæ— éœ€é¢å¤–åº“

```js
//é€šè¿‡åŒæ­¥çš„æ–¹å¼ï¼Œå®ç°å›è°ƒå’Œå¼‚æ­¥
async function fetchData() {
  try {
    const user = await getUser();
    const orders = await getOrders(user.id);
    const detail = await getOrderDetail(orders[0].id);
    console.log(detail);
  } catch (error) {
    console.error(error);
  }
}
```

## æ‰‹å†™Promise
ä¸Šé¢è®²äº†ä»å›è°ƒåœ°ç‹±åˆ°promiseå†åˆ°async/awaitã€‚ç°åœ¨ä¸“é—¨é’ˆå¯¹promiseè¿›è¡Œæ·±å…¥ç†è§£ã€‚
**Promiseçš„çŠ¶æ€**: `pending`ã€`fulfilled`(resolveåçš„çŠ¶æ€)ã€`rejected`(rejectåçš„çŠ¶æ€)
**ä¸¤ä¸ªç‰¹ç‚¹**ï¼š
  - å¯¹è±¡çš„çŠ¶æ€ä¸å—å¤–ç•Œå½±å“;
  - ä¸€æ—¦çŠ¶æ€æ”¹å˜ï¼Œå°±ä¸ä¼šå†å˜ï¼Œä»»ä½•æ—¶å€™éƒ½å¯ä»¥å¾—åˆ°è¿™ä¸ªç»“æœ(çŠ¶æ€ä¸å¯é€†)ã€‚Promise å¯¹è±¡çš„çŠ¶æ€æ”¹å˜ï¼Œåªæœ‰ä¸¤ç§å¯èƒ½ï¼šä» pending å˜ä¸º fulfilled å’Œä» pending å˜ä¸º rejectedã€‚åªè¦è¿™ä¸¤ç§æƒ…å†µå‘ç”Ÿï¼ŒçŠ¶æ€å°±å‡å›ºäº†ï¼Œä¸ä¼šå†å˜äº†ï¼Œä¼šä¸€ç›´ä¿æŒè¿™ä¸ªç»“æœï¼Œè¿™æ—¶å°±ç§°ä¸º resolvedï¼ˆå·²å®šå‹ï¼‰ã€‚

å®ä¾‹æ–¹æ³• - `.catch(...)`,`.finally(...)`
é™æ€æ–¹æ³• - `resolve(...)`,`reject(...)`,`race(...)`,`all(...)`,`allSettled(...)`,`any(...)`


::: details ğŸ’¡ Promise
æ‰‹å†™å®ç°ä¸€ä¸ªå¥½çš„promiseè¦å¦‚ä½•ä¸€æ­¥æ­¥å®ç°
æ‰‹å†™ Promise ä¸»è¦åˆ†ä¸ºå…­ä¸ªæ­¥éª¤ï¼š

**ç¬¬ä¸€æ­¥ï¼Œå®ç°åŸºç¡€æ¡†æ¶**ã€‚å®šä¹‰ä¸‰ä¸ªçŠ¶æ€å¸¸é‡ï¼Œåœ¨æ„é€ å‡½æ•°ä¸­åˆå§‹åŒ–çŠ¶æ€ã€
å€¼å’ŒåŸå› ï¼Œå®šä¹‰ resolve å’Œ reject å‡½æ•°æ¥æ”¹å˜çŠ¶æ€ï¼Œæœ€åæ‰§è¡Œ executorã€‚

**ç¬¬äºŒæ­¥ï¼Œå®ç°thenæ–¹æ³•**ã€‚åšå‚æ•°æ ¡éªŒå®ç°å€¼ç©¿é€ï¼Œæ ¹æ®çŠ¶æ€æ‰§è¡Œå¯¹åº”çš„å›è°ƒã€‚

**ç¬¬ä¸‰æ­¥ï¼Œå®ç°é“¾å¼è°ƒç”¨**ã€‚then æ–¹æ³•è¿”å›ä¸€ä¸ªæ–°çš„ Promiseï¼Œåœ¨æ–° Promise ä¸­
æ‰§è¡Œå›è°ƒå¹¶ resolve è¿”å›å€¼ã€‚

**ç¬¬å››æ­¥ï¼Œå¤„ç†å¼‚æ­¥**ã€‚å®šä¹‰å›è°ƒé˜Ÿåˆ—ï¼Œå¦‚æœçŠ¶æ€æ˜¯ pendingï¼Œå°†å›è°ƒå­˜å…¥é˜Ÿåˆ—ï¼Œ
ç­‰å¼‚æ­¥å®Œæˆåå†æ‰§è¡Œã€‚

**ç¬¬äº”æ­¥ï¼Œå®ç°Promiseè§£æè¿‡ç¨‹**ã€‚ç”¨ resolvePromiseå‡½æ•°å¤„ç†thenå›è°ƒçš„
è¿”å›å€¼ï¼Œæ”¯æŒè¿”å› Promiseã€thenableå¯¹è±¡å’Œæ™®é€šå€¼ã€‚

**ç¬¬å…­æ­¥ï¼Œå®ç°é™æ€æ–¹æ³•**ã€‚åŒ…æ‹¬ resolveã€rejectã€allã€raceã€allSettledã€any ç­‰ã€‚

æ ¸å¿ƒéš¾ç‚¹æ˜¯ resolvePromise å‡½æ•°å’Œå¼‚æ­¥å¤„ç†çš„å›è°ƒé˜Ÿåˆ—ã€‚
::: 

### 1.å®ç°åŸºç¡€æ¡†æ¶
æ‰§è¡Œexecutorï¼Œç›®çš„æ˜¯åœ¨new Promise((resolve, reject) => { ... })å†…çš„åŒæ­¥ä»£ç æœ‰é”™è¯¯æ—¶ï¼ŒæŠ›å‡ºé”™è¯¯
```js
å®šä¹‰ä¸‰ä¸ªçŠ¶æ€å¸¸é‡ï¼Œåœ¨æ„é€ å‡½æ•°ä¸­åˆå§‹åŒ–çŠ¶æ€ã€å€¼å’ŒåŸå› ï¼Œå®šä¹‰ resolve å’Œ reject å‡½æ•°æ¥æ”¹å˜çŠ¶æ€ï¼Œæœ€åæ‰§è¡Œexecutorã€‚
const PADDING = "padding";
const FULFILLED = "fulfilled";
const REJECTED = "rejected";
class myPromise {
  constructor(executor) {
    //åˆå§‹åŒ–çŠ¶æ€
    this.status = PADDING;
    this.result = undefined;
    this.reason = undefined;
    //å®šä¹‰ä¸¤ä¸ªç®­å¤´å‡½æ•°ï¼Œèƒ½æ¥æ”¶å®ä¾‹çš„å‚æ•°
    const resolve = (result) => {
      //æ”¹å˜çŠ¶æ€
      if (this.status === PADDING) {
        this.status = FULFILLED;
        this.result = result
      }
    };
    const reject = (reason) => {
      if (this.status === PADDING) {
        this.status = REJECTED;
        this.reason = reason
      }
    };
    //æ‰§è¡Œexecutorï¼Œç›®çš„æ˜¯åœ¨new Promise((resolve, reject) => { ... })å†…çš„åŒæ­¥ä»£ç æœ‰é”™è¯¯æ—¶ï¼ŒæŠ›å‡ºé”™è¯¯
    try {
      executor(resolve, reject);
    } catch (error) {
      reject(error);
    }
  }
}
```
### 2.å®ç°thenæ–¹æ³•
åšå‚æ•°æ ¡éªŒå®ç°å€¼ç©¿é€ï¼Œæ ¹æ®çŠ¶æ€æ‰§è¡Œå¯¹åº”çš„å›è°ƒã€‚è¿™é‡Œçš„å‚æ•°æ ¡éªŒçš„ç›®çš„æ˜¯åˆ¤æ–­è¿”å›çš„æ˜¯å¦æ˜¯å‡½æ•°ï¼Œå¦‚æœä¸æ˜¯å‡½æ•°å°†å€¼ä¼ ä¸‹å»ï¼Œä¹Ÿå°±æ˜¯è¯´`x => x`ã€‚å¦‚æœä¼ å…¥çš„ä¸æ˜¯å‡½æ•°ï¼Œä¸Šä¸€ä¸ª Promise çš„ç»“æœï¼ˆæˆåŠŸå€¼/å¤±è´¥åŸå› ï¼‰ä¼šåŸå°ä¸åŠ¨ä¼ é€’ç»™ä¸‹ä¸€ä¸ªthenã€‚
```js
const PADDING = "padding";
const FULFILLED = "fulfilled";
const REJECTED = "rejected";
class myPromise {
  constructor(executor){...}
  //thenæ–¹æ³•ä¸­è¦åšä»€ä¹ˆï¼Ÿåœ¨promiseä¸­æˆ‘ä»¬é€šè¿‡thenè¿›è¡Œæ‰§è¡Œå¯¹åº”çš„å›è°ƒ
  then(onFulfilled,onRejected) {
    //å…ˆåšä¸€ä¸ªæ˜¯å¦ä¸ºå‡½æ•°çš„åˆ¤æ–­ï¼Œå¦‚æœæ˜¯å‡½æ•°ï¼Œæ¥æ”¶å‡½æ•°;å¦‚æœæ˜¯éå‡½æ•°ï¼Œè¿›è¡Œé€å€¼ä¼ é€’ï¼Œå°†ä¸Šä¸€ä¸ª Promise çš„ç»“æœåŸå°ä¸åŠ¨ä¼ é€’ç»™ä¸‹ä¸€ä¸ª then
    onFulfilled = typeof onFulfilled === 'function' ? onFulfilled : x => x;
    onRejected = typeof onRejected === 'function' ? onRejected : x=>{throw x}
    //æ ¹æ®çŠ¶æ€è¿›è¡Œåˆ¤æ–­ï¼Œå¦‚æœçŠ¶æ€æ˜¯fulfilledï¼Œæ‰§è¡ŒonFulfilledä¼ å›çš„å‡½æ•°;çŠ¶æ€æ˜¯rejected,æ‰§è¡ŒonRejectedä¼ å›çš„å‡½æ•°
    if (this.status === FULFILLED){
      onFulfilled(this.result)   //è¿™é‡Œä¸ºä»€ä¹ˆç”¨thisï¼Ÿåœ¨æ„é€ å‡½æ•°ä¸­çš„thisæ˜¯æŒ‡å®šå½“å‰å®ä¾‹å¯¹è±¡ï¼Œè¿™é‡Œçš„thiså› ä¸ºthenæ–¹æ³•æ˜¯è¢«å®ä¾‹å¯¹è±¡è°ƒç”¨çš„ï¼Œæ‰€ä»¥ä¹Ÿæ˜¯æŒ‡å‘å®ä¾‹å¯¹è±¡
    } else if(this.status === REJECTED){
      onRejected(this.reason)
    }
  }  
}
```

### 3.å›è°ƒé˜Ÿåˆ—å’Œå¼‚æ­¥ä»»åŠ¡
å®ç°thenæ–¹æ³•åç°æœ‰çš„myPromiseä»¥åŠæ‰§è¡Œå¯¹åº”çŠ¶æ€çš„å›è°ƒ,ä½†æ˜¯æˆ‘ä»¬ä¸èƒ½è®©å…¶è¿›è¡Œå¤šæ¬¡è°ƒç”¨å’Œå¼‚æ­¥ä»»åŠ¡ã€‚
::: details é—®é¢˜åˆ†æ
æ¯”å¦‚ä¸‹é¢çš„å¼‚æ­¥è°ƒç”¨å’Œå¤šå›è°ƒä»»åŠ¡çš„åœºæ™¯,æˆ‘ä»¬å‘ç°ä¸€ä¸ªé—®é¢˜ï¼Œå› ä¸ºæ„å»ºå‡½æ•°å†…çš„executoræ˜¯å¼‚æ­¥æ“ä½œï¼Œæ‰€ä»¥ä¼šç«‹å³æ‰§è¡Œp.thenï¼Œä½†æ˜¯å½“å‰çš„çŠ¶æ€è¿˜æ˜¯padding,å½“å‰çš„ä»£ç æ²¡æœ‰æŠŠthençš„å›è°ƒå­˜å…¥é˜Ÿåˆ—ï¼Œå¯¼è‡´ç­‰å¼‚æ­¥ä»»åŠ¡ç»“æŸåï¼Œè™½ç„¶çŠ¶æ€ä¿®æ”¹äº†ï¼Œä½†æ˜¯å·²ç»æ²¡æœ‰å›è°ƒå¯ä»¥æ‰§è¡Œã€‚

![Promiseå¼‚æ­¥](/qian/Promiseå¼‚æ­¥.png)

```js [å¼‚æ­¥æ“ä½œå¤šæ¬¡è°ƒç”¨åœºæ™¯]
const p = new myPromise((resolve, reject) => {
    setTimeout(() => resolve("å¼‚æ­¥æˆåŠŸ"), 1000);
});

p.then(
  (res) => {
    console.log("then1:", res);
  },
  (err) => {
    console.log("then1:", err);
  }
);

p.then(
  (res) => {
    console.log("then2:", res);
  },
  (err) => {
    console.log("then2:", err);
  }
);
```
:::

æ€»ç»“ä¸Šé¢çš„é—®é¢˜å°±æ˜¯--**ç¼ºå°‘å›è°ƒé˜Ÿåˆ— + å¼‚æ­¥å›è°ƒæœªç¼“å­˜**ã€‚
- å®ç°å¼‚æ­¥ï¼Œthenæ–¹æ³•ä¸­åŠ å…¥å¼‚æ­¥æ“ä½œ
- å°†å›è°ƒåŠ å…¥åˆ°å¯¹åº”çš„å›è°ƒé˜Ÿåˆ—ä¸­
- åœ¨resolveå’Œrejectä¸­ï¼Œå°†å­˜å‚¨çš„å›è°ƒé˜Ÿåˆ—è¿›è¡Œéå†


::: code-group
```js [å¼‚æ­¥å°è£…]
//ä¹Ÿå¯ä»¥ç”¨setTimeout
function runAsynctask(callback) {
  if (typeof queueMicrotask === "function") {
    queueMicrotask(callback);
  } else if (typeof MutationObserver === "function") {
    const observer = new MutationObserver(callback);
    const divNode = document.createElement("div");
    observer.observe(divNode, { childList: true });
    divNode.innerText = "ç›‘å¬å¯¹è±¡ä¿®æ”¹äº†ï¼Œå¾®ä»»åŠ¡å½¢å¼æ‰§è¡Œå›è°ƒ";
  } else {
    setTimeout(callback, 0);
  }
}
```

```js [thenä¸­æ·»åŠ å¼‚æ­¥å’Œå›è°ƒé˜Ÿåˆ—]
const PADDING = "padding";
const FULFILLED = "fulfilled";
const REJECTED = "rejected";
class myPromise {
constructor(executor) {
  //åˆå§‹åŒ–çŠ¶æ€
  this.status = PADDING;
  this.result = undefined;
  this.reason = undefined;
  this.onFulfilledCallbacks = [];
  this.onRejectedCallbacks = [];
  //å®šä¹‰ä¸¤ä¸ªç®­å¤´å‡½æ•°ï¼Œèƒ½æ¥æ”¶å®ä¾‹çš„å‚æ•°
  const resolve = (result) => {
    //æ”¹å˜çŠ¶æ€
    if (this.status === PADDING) {
      this.status = FULFILLED;
      this.result = result;
      this.onFulfilledCallbacks.forEach(fn => fn());  //è¿™ä¸€æ­¥çš„æ“ä½œæ˜¯å¯¹å¼‚æ­¥é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡æ‹¿å‡ºæ¥æ‰§è¡Œ
    }
  };
  const reject = (reason) => {
    if (this.status === PADDING) {
      this.status = REJECTED;
      this.reason = reason;
      this.onRejectedCallbacks.forEach(fn => fn());
    }
  };
  //æ‰§è¡Œexecutorï¼Œç›®çš„æ˜¯åœ¨new Promise((resolve, reject) => { ... })å†…çš„åŒæ­¥ä»£ç æœ‰é”™è¯¯æ—¶ï¼ŒæŠ›å‡ºé”™è¯¯
  try {
    executor(resolve, reject);
  } catch (error) {
    reject(error);
  }
}

then(onFulfilled, onRejected) {
  //å…ˆåšä¸€ä¸ªæ˜¯å¦ä¸ºå‡½æ•°çš„åˆ¤æ–­ï¼Œå¦‚æœæ˜¯å‡½æ•°ï¼Œæ¥æ”¶å‡½æ•°;å¦‚æœæ˜¯éå‡½æ•°ï¼Œè¿›è¡Œé€å€¼ä¼ é€’ï¼Œå°†ä¸Šä¸€ä¸ª Promise çš„ç»“æœåŸå°ä¸åŠ¨ä¼ é€’ç»™ä¸‹ä¸€ä¸ª then
  onFulfilled =
    typeof onFulfilled === "function" ? onFulfilled : (x) => x;
  onRejected =
    typeof onRejected === "function"
      ? onRejected
      : (x) => {
          throw x;
        };
  //æ ¹æ®çŠ¶æ€è¿›è¡Œåˆ¤æ–­ï¼Œå¦‚æœçŠ¶æ€æ˜¯fulfilledï¼Œæ‰§è¡ŒonFulfilledä¼ å›çš„å‡½æ•°;çŠ¶æ€æ˜¯rejected,æ‰§è¡ŒonRejectedä¼ å›çš„å‡½æ•°
  if (this.status === FULFILLED) {
    runAsynctask(() => {   //å°†å›è°ƒä¿®æ”¹ä¸ºå¼‚æ­¥ä»»åŠ¡
      onFulfilled(this.result);
    });
    //è¿™é‡Œä¸ºä»€ä¹ˆç”¨thisï¼Ÿåœ¨æ„é€ å‡½æ•°ä¸­çš„thisæ˜¯æŒ‡å®šå½“å‰å®ä¾‹å¯¹è±¡ï¼Œè¿™é‡Œçš„thiså› ä¸ºthenæ–¹æ³•æ˜¯è¢«å®ä¾‹å¯¹è±¡è°ƒç”¨çš„ï¼Œæ‰€ä»¥ä¹Ÿæ˜¯æŒ‡å‘å®ä¾‹å¯¹è±¡
  } else if (this.status === REJECTED) {
    runAsynctask(() => {   //å°†å›è°ƒä¿®æ”¹ä¸ºå¼‚æ­¥ä»»åŠ¡
      onRejected(this.reason);
    });
  } else if (this.status === PADDING) {
    //åœ¨çŠ¶æ€ä¸ºPADDINGæ—¶ï¼Œå°†å°†å›è°ƒä¿®æ”¹ä¸ºå¼‚æ­¥ä»»åŠ¡ï¼Œå¹¶æ”¾åˆ°å¯¹åº”çš„æ•°ç»„(é˜Ÿåˆ—)ä¸­
    this.onFulfilledCallbacks.push(() => {
      runAsynctask(() => {  
        onFulfilled(this.result);
      });
    }),
      this.onRejectedCallbacks.push(() => {
        runAsynctask(() => {
          onRejected(this.reason);
        });
      });
  }
}
}
```
:::


### 4.å®ç°é“¾å¼è°ƒç”¨
åœ¨å®ç°å¼‚æ­¥å’Œå›è°ƒé˜Ÿåˆ—åï¼Œå¦‚æœæƒ³è¦æ‰§è¡Œå¤šä¸ªå¼‚æ­¥ä»»åŠ¡ï¼Œåªèƒ½è¿›è¡ŒåµŒå¥—ç€å†™ã€‚
```js
//å¦‚å…ˆè¯·æ±‚ç”¨æˆ·ä¿¡æ¯ â†’ å†è¯·æ±‚ç”¨æˆ·è®¢å• â†’ å†è¯·æ±‚è®¢å•è¯¦æƒ…
const p1 = new myPromise((resolve) => {
  setTimeout(() => resolve("ç”¨æˆ·ä¿¡æ¯"), 1000);
});

// æ— é“¾å¼è°ƒç”¨ï¼šåªèƒ½åµŒå¥— thenï¼Œå±‚çº§è¶Šæ·±è¶Šéš¾ç»´æŠ¤
p1.then(res1 => {
  console.log(res1); // 1ç§’åæ‰“å°ç”¨æˆ·ä¿¡æ¯
  const p2 = new myPromise((resolve) => {  
    setTimeout(() => resolve("ç”¨æˆ·è®¢å•"), 1000);
  });
  p2.then(res2 => {
    console.log(res2); // 2ç§’åæ‰“å°ç”¨æˆ·è®¢å•
    const p3 = new myPromise((resolve) => {
      setTimeout(() => resolve("è®¢å•è¯¦æƒ…"), 1000);
    });
    p3.then(res3 => {
      console.log(res3); // 3ç§’åæ‰“å°è®¢å•è¯¦æƒ…
    });
  });
});
```
ä»ä¸Šé¢çš„ä¾‹å­ä¸­æˆ‘ä»¬èƒ½çœ‹åˆ°thenæ–¹æ³•ä¸­è¦æœ‰æ–°çš„promiseå®ä¾‹ï¼Œè¿™ä¹Ÿæ˜¯å®ç°**é“¾å¼è°ƒç”¨çš„æ ¸å¿ƒé€»è¾‘--thenæ–¹æ³•è¿”å›æ–°çš„myPromiseå®ä¾‹**ã€‚è¿˜æœ‰å°±æ˜¯ç»Ÿä¸€é”™è¯¯ã€‚é‚£ä¹ˆæ˜¯ä¸æ˜¯æƒ³ä¸‹é¢çš„ä»£ç å°†thenä¸­å›è°ƒå‡½æ•°çŠ¶æ€åˆ¤æ–­æ”¾åˆ°é‡Œé¢å³å¯ï¼Ÿæ˜¾ç„¶æ˜¯ä¸è¡Œçš„ï¼Œå› ä¸ºå½“å‰çš„å›è°ƒå‡½æ•°å¤„ç†ä¸­ï¼Œæ²¡åŠæ³•æ•æ‰ä¸Šä¸€ä¸ªPromiseçš„è¿”å›å€¼ï¼Œè®©æ–° Promise çŠ¶æ€å…³è”è¿”å›å€¼ã€‚
```js
const promise2 =new myPromise(()=>{
  if (this.status === FULFILLED){}
  else if (this.status === REJECTED){}
  else if (this.status === PADDING){}
})
```
